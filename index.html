<!DOCTYPE html>
<html class="dark" lang="en">
<head>
    <meta charset="utf-8"/>
    <meta content="width=device-width, initial-scale=1.0" name="viewport"/>
    <title>Celiac Safe Finder - Find Verified Gluten-Free Restaurants</title>
    <meta name="description" content="Find verified gluten-free restaurants and hotels worldwide. Celiac-safe dining options with detailed safety information.">

    <!-- Fonts -->
    <link href="https://fonts.googleapis.com" rel="preconnect"/>
    <link crossorigin="" href="https://fonts.gstatic.com" rel="preconnect"/>
    <link href="https://fonts.googleapis.com/css2?family=Spline+Sans:wght@300;400;500;600;700&family=Noto+Sans:wght@400;500;600;700&display=swap" rel="stylesheet"/>
    <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:wght,FILL@100..700,0..1&display=swap" rel="stylesheet"/>

    <!-- Leaflet CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin=""/>

    <!-- Tailwind -->
    <script src="https://cdn.tailwindcss.com?plugins=forms,container-queries"></script>
    <script id="tailwind-config">
        tailwind.config = {
            darkMode: "class",
            theme: {
                extend: {
                    colors: {
                        "primary": "#36e27b",
                        "background-light": "#f6f8f7",
                        "background-dark": "#112117",
                        "surface-dark": "#1E1E1E",
                    },
                    fontFamily: {
                        "display": ["Spline Sans", "sans-serif"],
                        "body": ["Noto Sans", "sans-serif"],
                    },
                    borderRadius: {"DEFAULT": "1rem", "lg": "2rem", "xl": "3rem", "full": "9999px"},
                    boxShadow: {
                        'neon': '0 0 10px rgba(54, 226, 123, 0.5), 0 0 20px rgba(54, 226, 123, 0.3)',
                    }
                },
            },
        }
    </script>

    <style>
        body {
            overscroll-behavior: none;
            height: 100dvh;
            width: 100vw;
        }

        /* Utilities */
        .hide-scrollbar::-webkit-scrollbar { display: none; }
        .hide-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }

        .glass-panel {
            background: rgba(30, 30, 30, 0.85);
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
        }

        /* Map Pin Styles */
        .custom-pin {
            background-color: #36e27b;
            border: 2px solid white;
            border-radius: 50%;
            box-shadow: 0 0 10px rgba(54, 226, 123, 0.6);
            transition: all 0.3s ease;
        }
        .custom-pin:hover, .custom-pin.active {
            transform: scale(1.2);
            box-shadow: 0 0 15px rgba(54, 226, 123, 0.9);
            background-color: white;
            border-color: #36e27b;
        }

        /* Leaflet Overrides for Dark Mode */
        .leaflet-popup-content-wrapper, .leaflet-popup-tip {
            background: #1E1E1E;
            color: white;
            border: 1px solid rgba(255,255,255,0.1);
            border-radius: 12px;
        }
        .leaflet-popup-content {
            margin: 10px;
            font-family: 'Spline Sans', sans-serif;
        }
        .leaflet-bar a {
            background-color: rgba(30, 30, 30, 0.9) !important;
            color: white !important;
            border-bottom: 1px solid rgba(255,255,255,0.1) !important;
        }
        .leaflet-bar a:hover {
            background-color: #36e27b !important;
            color: black !important;
        }
        .leaflet-control-attribution {
            background: rgba(0,0,0,0.5) !important;
            color: #aaa !important;
        }
        .leaflet-control-attribution a { color: #36e27b !important; }

        /* Animation for Bottom Sheet */
        .slide-up { animation: slideUp 0.3s cubic-bezier(0.16, 1, 0.3, 1) forwards; }
        @keyframes slideUp { from { transform: translateY(100%); } to { transform: translateY(0); } }

        .fade-in { animation: fadeIn 0.3s ease forwards; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }

        /* Search results highlighting */
        .search-highlight {
            background-color: rgba(54, 226, 123, 0.2);
            font-weight: 600;
        }
    </style>
</head>
<body class="bg-background-dark font-display text-white overflow-hidden relative selection:bg-primary selection:text-black">

    <!-- 1. Map Layer (Z-0) -->
    <div id="map" class="absolute inset-0 z-0 bg-[#0f1512]" role="application" aria-label="Map showing celiac-safe restaurant locations"></div>

    <!-- Disclaimer Banner -->
    <div class="absolute top-2 left-1/2 transform -translate-x-1/2 z-50 max-w-lg px-4" id="disclaimer-banner">
        <div class="bg-yellow-900/90 backdrop-blur border border-yellow-600/50 rounded-lg px-4 py-2 text-xs text-yellow-100 flex items-start gap-2 shadow-lg">
            <span class="material-symbols-outlined text-yellow-400 text-sm shrink-0">info</span>
            <p>
                <strong>Disclaimer:</strong> Information is community-sourced. Always verify gluten-free safety directly with the establishment before dining.
                <button onclick="dismissDisclaimer()" class="ml-2 underline hover:text-white" aria-label="Dismiss disclaimer">Got it</button>
            </p>
        </div>
    </div>

    <!-- 2. Top UI Layer (Z-20) -->
    <div class="absolute top-0 left-0 w-full z-20 flex flex-col gap-3 p-4 pt-12 pointer-events-none">
        <!-- Search Bar -->
        <div class="pointer-events-auto w-full max-w-md mx-auto shadow-2xl">
            <label for="search-input" class="sr-only">Search celiac-safe restaurants by name or location</label>
            <div class="flex flex-col w-full">
                <div class="flex w-full flex-1 items-stretch rounded-full h-12 glass-panel border border-primary/30 focus-within:border-primary transition-colors">
                    <div class="text-primary flex border-none items-center justify-center pl-4 rounded-l-full" aria-hidden="true">
                        <span class="material-symbols-outlined">search</span>
                    </div>
                    <input
                        id="search-input"
                        type="search"
                        class="flex w-full min-w-0 flex-1 resize-none overflow-hidden rounded-full text-white focus:outline-0 focus:ring-0 border-none bg-transparent h-full placeholder:text-gray-400 px-3 text-base font-normal leading-normal"
                        placeholder="Search by name, location, or cuisine..."
                        autocomplete="off"
                        aria-describedby="search-results-count"
                    />
                    <button
                        id="clear-search-btn"
                        class="text-white items-center justify-center pr-4 rounded-r-full cursor-pointer hover:text-primary transition-colors hidden"
                        aria-label="Clear search"
                        onclick="clearSearch()"
                    >
                        <span class="material-symbols-outlined">close</span>
                    </button>
                </div>
                <div id="search-results-count" class="text-xs text-gray-400 mt-2 text-center" role="status" aria-live="polite"></div>
            </div>
        </div>

        <!-- Filter Chips -->
        <div class="pointer-events-auto w-full overflow-x-auto hide-scrollbar pl-1" role="tablist" aria-label="Filter restaurants by safety certification">
            <div class="flex gap-3 pb-2 pr-4" id="filter-container">
                <button
                    onclick="filterMap('all')"
                    class="filter-chip active flex h-8 shrink-0 items-center justify-center gap-x-2 rounded-full bg-primary text-black border border-primary px-4 shadow-neon active:scale-95 transition-transform"
                    role="tab"
                    aria-selected="true"
                    aria-controls="restaurant-list"
                >
                    <p class="text-sm font-bold leading-normal">All Spots</p>
                </button>
                <button
                    onclick="filterMap('Type 1')"
                    class="filter-chip flex h-8 shrink-0 items-center justify-center gap-x-2 rounded-full bg-surface-dark border border-white/10 px-4 shadow-lg active:scale-95 transition-all hover:border-primary/50"
                    role="tab"
                    aria-selected="false"
                    aria-controls="restaurant-list"
                >
                    <p class="text-white text-sm font-medium leading-normal">The Bubble</p>
                    <span class="material-symbols-outlined text-primary text-[16px]" aria-hidden="true">verified_user</span>
                </button>
                <button
                    onclick="filterMap('Type 2')"
                    class="filter-chip flex h-8 shrink-0 items-center justify-center gap-x-2 rounded-full bg-surface-dark border border-white/10 px-4 shadow-lg active:scale-95 transition-all hover:border-primary/50"
                    role="tab"
                    aria-selected="false"
                    aria-controls="restaurant-list"
                >
                    <p class="text-white text-sm font-medium leading-normal">Fort Knox</p>
                    <span class="material-symbols-outlined text-primary text-[16px]" aria-hidden="true">lock</span>
                </button>
            </div>
        </div>
    </div>

    <!-- 3. Bottom Sheet Layer (Z-30) -->
    <div
        id="bottom-sheet"
        class="absolute bottom-0 left-0 w-full z-30 flex flex-col bg-surface-dark rounded-t-[24px] shadow-[0_-5px_30px_rgba(0,0,0,0.8)] border-t border-white/10 transition-all duration-300 ease-out"
        style="height: 45vh;"
        role="complementary"
        aria-label="Restaurant list and details"
    >

        <!-- Drag Handle -->
        <div class="w-full flex justify-center pt-3 pb-1 cursor-grab active:cursor-grabbing shrink-0" id="drag-handle" aria-hidden="true">
            <div class="h-1.5 w-12 rounded-full bg-white/20"></div>
        </div>

        <!-- Content Container -->
        <div class="flex-1 overflow-hidden relative">

            <!-- LIST VIEW -->
            <div id="list-view" class="h-full flex flex-col fade-in">
                <div class="px-5 pb-3 pt-2 shrink-0 flex justify-between items-end">
                    <h2 class="text-white tracking-tight text-[22px] font-bold leading-tight" id="list-title">Safe Spots Nearby</h2>
                </div>
                <div
                    class="flex-1 overflow-y-auto px-4 pb-8 space-y-4"
                    id="restaurant-list"
                    role="list"
                    aria-label="List of celiac-safe restaurants"
                >
                    <!-- Cards injected via JS -->
                </div>
            </div>

            <!-- DETAIL VIEW (Initially Hidden) -->
            <div id="detail-view" class="h-full flex flex-col hidden bg-surface-dark absolute inset-0 z-40" role="dialog" aria-modal="true" aria-labelledby="detail-title">
                <!-- Content injected via JS -->
            </div>

        </div>
    </div>

    <!-- Leaflet JS -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>

    <!-- App Data -->
    <script type="module">
        import { restaurants, getRestaurantImage } from './data.js';

        // --- APP STATE ---
        const appState = {
            allRestaurants: restaurants,
            filteredRestaurants: restaurants,
            markers: {},
            activeFilter: 'all',
            searchQuery: '',
            map: null,
            userLocation: null
        };

        // --- UTILITIES ---
        function escapeHTML(str) {
            const div = document.createElement('div');
            div.textContent = str;
            return div.innerHTML;
        }

        function highlightSearchTerm(text, query) {
            if (!query) return escapeHTML(text);
            const escapedText = escapeHTML(text);
            const regex = new RegExp(`(${query})`, 'gi');
            return escapedText.replace(regex, '<span class="search-highlight">$1</span>');
        }

        function calculateDistance(lat1, lon1, lat2, lon2) {
            const R = 6371; // Earth's radius in km
            const dLat = (lat2 - lat1) * Math.PI / 180;
            const dLon = (lon2 - lon1) * Math.PI / 180;
            const a = Math.sin(dLat/2) * Math.sin(dLat/2) +
                      Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) *
                      Math.sin(dLon/2) * Math.sin(dLon/2);
            const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
            return R * c;
        }

        // --- SEARCH FUNCTIONALITY ---
        function searchRestaurants(query) {
            appState.searchQuery = query.toLowerCase().trim();

            if (!appState.searchQuery) {
                appState.filteredRestaurants = appState.allRestaurants;
                document.getElementById('clear-search-btn').classList.add('hidden');
                document.getElementById('search-results-count').textContent = '';
            } else {
                appState.filteredRestaurants = appState.allRestaurants.filter(r => {
                    return r.name.toLowerCase().includes(appState.searchQuery) ||
                           r.location.toLowerCase().includes(appState.searchQuery) ||
                           r.vibe.toLowerCase().includes(appState.searchQuery) ||
                           r.desc.toLowerCase().includes(appState.searchQuery) ||
                           r.safetyLabel.toLowerCase().includes(appState.searchQuery);
                });
                document.getElementById('clear-search-btn').classList.remove('hidden');

                const count = appState.filteredRestaurants.length;
                document.getElementById('search-results-count').textContent =
                    count === 0 ? 'No results found' : `${count} result${count !== 1 ? 's' : ''} found`;
            }

            applyFilters();
        }

        window.clearSearch = function() {
            document.getElementById('search-input').value = '';
            searchRestaurants('');
        };

        // Setup search input
        const searchInput = document.getElementById('search-input');
        let searchTimeout;
        searchInput.addEventListener('input', (e) => {
            clearTimeout(searchTimeout);
            searchTimeout = setTimeout(() => {
                searchRestaurants(e.target.value);
            }, 300);
        });

        // --- MAP INITIALIZATION ---
        function initMap() {
            appState.map = L.map('map', {
                zoomControl: false,
                attributionControl: true
            }).setView([40.75, -73.98], 13);

            L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png', {
                attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors &copy; <a href="https://carto.com/attributions">CARTO</a>',
                subdomains: 'abcd',
                maxZoom: 20
            }).addTo(appState.map);

            L.control.zoom({ position: 'topright' }).addTo(appState.map);

            // Try to get user location
            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(
                    (position) => {
                        appState.userLocation = {
                            lat: position.coords.latitude,
                            lng: position.coords.longitude
                        };
                        appState.map.setView([appState.userLocation.lat, appState.userLocation.lng], 13);

                        // Add user location marker
                        L.marker([appState.userLocation.lat, appState.userLocation.lng], {
                            icon: L.divIcon({
                                className: 'user-location-marker',
                                html: '<div style="background: #3b82f6; width: 16px; height: 16px; border-radius: 50%; border: 3px solid white; box-shadow: 0 0 10px rgba(59, 130, 246, 0.8);"></div>',
                                iconSize: [16, 16],
                                iconAnchor: [8, 8]
                            })
                        }).addTo(appState.map).bindPopup('Your Location');
                    },
                    (error) => {
                        console.log('Geolocation error:', error);
                    }
                );
            }
        }

        // --- MARKER FUNCTIONS ---
        function createCustomIcon(isActive) {
            return L.divIcon({
                className: 'custom-pin-container',
                html: `<div class="custom-pin ${isActive ? 'active' : ''} w-4 h-4"></div>`,
                iconSize: [16, 16],
                iconAnchor: [8, 8],
                popupAnchor: [0, -10]
            });
        }

        function highlightMarker(id) {
            Object.values(appState.markers).forEach(m => {
                m.setIcon(createCustomIcon(false));
            });
            if(appState.markers[id]) {
                appState.markers[id].setIcon(createCustomIcon(true));
            }
        }

        // --- CARD RENDERING ---
        function createCard(item) {
            const verifiedBadge = item.verified
                ? '<span class="material-symbols-outlined text-green-400 text-[14px]" aria-label="Verified" title="Verified by organization">verified</span>'
                : '<span class="material-symbols-outlined text-gray-500 text-[14px]" aria-label="Not verified" title="Not yet verified">info</span>';

            return `
                <div
                    onclick="flyToLocation(${item.id})"
                    class="bg-white/5 p-3 rounded-2xl flex gap-3 border border-white/5 shadow-lg hover:bg-white/10 transition-colors cursor-pointer group active:scale-[0.98]"
                    role="listitem"
                    tabindex="0"
                    onkeydown="if(event.key==='Enter') flyToLocation(${item.id})"
                >
                    <div class="w-24 h-24 shrink-0 rounded-xl overflow-hidden relative bg-gray-800">
                        <img alt="${escapeHTML(item.name)}" class="w-full h-full object-cover grayscale opacity-80 group-hover:grayscale-0 group-hover:opacity-100 transition-all duration-500" src="${item.image}">
                    </div>
                    <div class="flex-1 flex flex-col justify-between py-0.5">
                        <div class="flex justify-between items-start gap-2">
                            <div class="flex-1">
                                <h3 class="font-bold text-lg text-white group-hover:text-primary transition-colors leading-tight">${highlightSearchTerm(item.name, appState.searchQuery)}</h3>
                                <p class="text-xs text-gray-400 mt-1">${highlightSearchTerm(item.location, appState.searchQuery)} • ${item.vibe} • ${item.price}</p>
                            </div>
                            ${verifiedBadge}
                        </div>
                        <div class="flex flex-wrap gap-1.5 mt-2">
                            <div class="px-2 py-1 rounded-full bg-primary/10 border border-primary/40 flex items-center gap-1">
                                <span class="text-primary text-[10px] font-bold uppercase tracking-wider">${item.safetyLabel}</span>
                            </div>
                        </div>
                    </div>
                </div>
            `;
        }

        // --- FILTERING & RENDERING ---
        function applyFilters() {
            const listContainer = document.getElementById('restaurant-list');
            listContainer.innerHTML = '';

            let displayRestaurants = appState.filteredRestaurants;

            // Apply safety filter
            if (appState.activeFilter !== 'all') {
                displayRestaurants = displayRestaurants.filter(r => r.safetyClass === appState.activeFilter);
            }

            // Update markers
            appState.allRestaurants.forEach(item => {
                const marker = appState.markers[item.id];
                const shouldShow = displayRestaurants.some(r => r.id === item.id);

                if (shouldShow) {
                    if (!appState.map.hasLayer(marker)) appState.map.addLayer(marker);
                    listContainer.innerHTML += createCard(item);
                } else {
                    if (appState.map.hasLayer(marker)) appState.map.removeLayer(marker);
                }
            });

            // Update title
            const title = document.getElementById('list-title');
            const count = displayRestaurants.length;
            title.textContent = `${count} Safe Spot${count !== 1 ? 's' : ''} Found`;
        }

        window.filterMap = function(type) {
            appState.activeFilter = type;

            // Update Chip UI with ARIA
            const chips = document.querySelectorAll('.filter-chip');
            chips.forEach(chip => {
                const isActive = (chip.innerText.includes("All") && type === 'all') ||
                               (chip.innerText.includes("Bubble") && type === 'Type 1') ||
                               (chip.innerText.includes("Fort Knox") && type === 'Type 2');

                if (isActive) {
                    chip.className = "filter-chip active flex h-8 shrink-0 items-center justify-center gap-x-2 rounded-full bg-primary text-black border border-primary px-4 shadow-neon active:scale-95 transition-transform";
                    chip.setAttribute('aria-selected', 'true');
                } else {
                    chip.className = "filter-chip flex h-8 shrink-0 items-center justify-center gap-x-2 rounded-full bg-surface-dark border border-white/10 px-4 shadow-lg active:scale-95 transition-all hover:border-primary/50 text-white";
                    chip.setAttribute('aria-selected', 'false');
                }
            });

            applyFilters();
        };

        // --- DETAIL VIEW ---
        window.openDetailView = function(item) {
            const detailView = document.getElementById('detail-view');
            const bottomSheet = document.getElementById('bottom-sheet');

            const verifiedBadge = item.verified
                ? '<span class="text-green-400 text-xs">✓ Verified</span>'
                : '<span class="text-gray-400 text-xs">⚠ Not Yet Verified</span>';

            const badgesHtml = item.badges.map(b => `
                <div class="flex flex-col items-center gap-2 text-center group">
                    <div class="w-16 h-16 rounded-full border border-primary bg-primary/10 flex items-center justify-center shadow-[0_0_15px_rgba(54,226,123,0.15)]">
                        <span class="material-symbols-outlined text-primary text-[24px]" aria-hidden="true">verified</span>
                    </div>
                    <span class="text-[10px] font-medium leading-tight text-gray-300">${escapeHTML(b)}</span>
                </div>
            `).join('');

            detailView.innerHTML = `
                <div class="relative w-full h-48 shrink-0">
                    <img src="${item.image}" alt="${escapeHTML(item.name)}" class="w-full h-full object-cover">
                    <div class="absolute inset-0 bg-gradient-to-b from-transparent to-surface-dark"></div>

                    <button onclick="closeDetailView()" class="absolute top-4 left-4 w-10 h-10 rounded-full bg-surface-dark/60 backdrop-blur border border-white/10 flex items-center justify-center text-white active:bg-primary active:text-black transition-colors z-50" aria-label="Close details">
                        <span class="material-symbols-outlined">arrow_downward</span>
                    </button>
                </div>

                <div class="flex-1 overflow-y-auto px-6 -mt-6 relative z-10">
                    <div class="flex justify-between items-start mb-2">
                        <h1 id="detail-title" class="text-3xl font-bold tracking-tight text-white leading-none">${escapeHTML(item.name)}</h1>
                        ${verifiedBadge}
                    </div>

                    <div class="flex items-center gap-3 text-sm text-gray-300 mb-2">
                        <span>${escapeHTML(item.vibe)}</span>
                        <span class="w-1 h-1 rounded-full bg-gray-600"></span>
                        <span>${item.price}</span>
                    </div>

                    <p class="text-sm text-gray-400 mb-6">${escapeHTML(item.location)}</p>

                    <div class="p-4 rounded-xl bg-white/5 border border-white/5 mb-6">
                        <p class="text-gray-200 text-sm leading-relaxed">"${escapeHTML(item.desc)}"</p>
                    </div>

                    <h2 class="text-xs font-bold text-gray-400 uppercase tracking-wider mb-4">Safety Features</h2>
                    <div class="flex gap-4 overflow-x-auto hide-scrollbar pb-4">
                        ${badgesHtml}
                    </div>

                    <div class="flex flex-col gap-3 mt-4">
                        <button onclick="navigateToRestaurant(${item.lat}, ${item.lng}, '${escapeHTML(item.name)}')" class="w-full h-14 rounded-2xl bg-primary flex items-center justify-center gap-2 font-bold text-black shadow-neon hover:shadow-[0_0_20px_rgba(54,226,123,0.6)] active:scale-95 transition-all">
                            <span class="material-symbols-outlined">near_me</span>
                            Navigate Here
                        </button>

                        <a href="${item.website}" target="_blank" rel="noopener noreferrer" class="w-full h-14 rounded-2xl bg-surface-dark border border-white/10 flex items-center justify-center gap-2 font-bold text-white hover:bg-white/5 transition-all">
                            <span class="material-symbols-outlined">public</span>
                            Visit Website
                        </a>
                    </div>

                    <div class="mt-6 p-4 rounded-xl bg-yellow-900/20 border border-yellow-600/30">
                        <p class="text-xs text-yellow-200 leading-relaxed">
                            <strong>Safety Reminder:</strong> Always inform staff about your celiac disease and verify preparation methods. Cross-contamination risks vary.
                        </p>
                    </div>

                    <div class="h-20"></div>
                </div>
            `;

            bottomSheet.style.height = '85vh';
            document.getElementById('list-view').classList.add('hidden');
            detailView.classList.remove('hidden');
            detailView.classList.add('slide-up');
        };

        window.closeDetailView = function() {
            const bottomSheet = document.getElementById('bottom-sheet');
            const detailView = document.getElementById('detail-view');
            const listView = document.getElementById('list-view');

            bottomSheet.style.height = '45vh';
            detailView.classList.add('hidden');
            listView.classList.remove('hidden');
            listView.classList.add('fade-in');

            highlightMarker(null);

            if(appState.map.getZoom() > 13) {
                // Optional: reset zoom
            }
        };

        window.flyToLocation = function(id) {
            const item = appState.allRestaurants.find(r => r.id === id);
            if(item) {
                appState.map.flyTo([item.lat, item.lng], 15, { duration: 1.5 });
                highlightMarker(id);
                openDetailView(item);
            }
        };

        // --- NAVIGATION FUNCTIONALITY ---
        window.navigateToRestaurant = function(lat, lng, name) {
            const destination = `${lat},${lng}`;
            const encodedName = encodeURIComponent(name);

            // Try to detect device/browser to open appropriate map
            const userAgent = navigator.userAgent || navigator.vendor || window.opera;

            // iOS
            if (/iPad|iPhone|iPod/.test(userAgent) && !window.MSStream) {
                window.open(`maps://maps.apple.com/?q=${encodedName}&ll=${destination}`, '_blank');
            }
            // Android
            else if (/android/i.test(userAgent)) {
                window.open(`geo:${destination}?q=${destination}(${encodedName})`, '_blank');
            }
            // Default to Google Maps web
            else {
                window.open(`https://www.google.com/maps/dir/?api=1&destination=${destination}&destination_place_id=${encodedName}`, '_blank');
            }
        };

        // --- INITIALIZATION ---
        function initApp() {
            initMap();

            const listContainer = document.getElementById('restaurant-list');
            listContainer.innerHTML = '';

            // Add Markers and build list
            appState.allRestaurants.forEach(item => {
                const marker = L.marker([item.lat, item.lng], { icon: createCustomIcon(false) })
                    .addTo(appState.map)
                    .bindPopup(`<b>${escapeHTML(item.name)}</b><br>${escapeHTML(item.vibe)}`);

                marker.on('click', () => {
                    openDetailView(item);
                    highlightMarker(item.id);
                });

                appState.markers[item.id] = marker;
                listContainer.innerHTML += createCard(item);
            });

            // Update title
            document.getElementById('list-title').textContent = `${appState.allRestaurants.length} Safe Spots Nearby`;
        }

        // --- DISCLAIMER ---
        window.dismissDisclaimer = function() {
            document.getElementById('disclaimer-banner').style.display = 'none';
            localStorage.setItem('disclaimerDismissed', 'true');
        };

        // Check if disclaimer was previously dismissed
        if (localStorage.getItem('disclaimerDismissed') === 'true') {
            document.getElementById('disclaimer-banner').style.display = 'none';
        }

        // Start the app
        initApp();
    </script>
</body>
</html>
